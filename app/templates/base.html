<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IPS FULANO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --ips-red: #e53935; }
        .btn-ips { background-color: var(--ips-red); border-color: var(--ips-red); }
        .btn-ips:hover { background-color: #c62828; }
        .navbar-brand { font-weight: bold; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark" style="background-color: #e53935;">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">IPS FULANO</a>
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Hola, {{ current_user.nombre }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('main.cambiar_password') }}">Cambiar contraseña</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.logout') }}">Cerrar sesión</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Convert flash messages to SweetAlert
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const message = alert.textContent.trim();
                let icon = 'info';
                if (alert.classList.contains('alert-success')) icon = 'success';
                else if (alert.classList.contains('alert-danger')) icon = 'error';
                else if (alert.classList.contains('alert-warning')) icon = 'warning';

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    icon: icon,
                    title: message
                });
                alert.remove(); // Remove the Bootstrap alert
            });
        });

        // Auto-logout after inactivity
        let inactivityTimer;
        let warningShown = false;
        const inactivityLimit = 3 * 60 * 1000; // 3 minutes
        const warningTime = 2 * 60 * 1000; // 2 minutes after warning

        function resetTimer() {
            clearTimeout(inactivityTimer);
            if (warningShown) {
                warningShown = false;
            }
            inactivityTimer = setTimeout(showWarning, inactivityLimit);
        }

        function showWarning() {
            warningShown = true;
            Swal.fire({
                title: 'Sesión inactiva',
                text: 'Su sesión se cerrará automáticamente en 2 minutos por inactividad.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Continuar sesión',
                cancelButtonText: 'Cerrar ahora'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetTimer();
                } else {
                    window.location.href = '{{ url_for("main.logout", inactive=1) }}';
                }
            });

            // Auto logout after warning time
            setTimeout(() => {
                if (warningShown) {
                    window.location.href = '{{ url_for("main.logout", inactive=1) }}';
                }
            }, warningTime);
        }

        // Events to reset timer
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('click', resetTimer);
        document.addEventListener('scroll', resetTimer);

        // Start timer
        resetTimer();
    </script>
</body>
</html>
