{% extends "base.html" %}

{% block title %}Pacientes - IPS Fulano{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Gestión de Pacientes</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('main.crear_paciente') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nuevo Paciente
            </a>
        </div>
    </div>

    <!-- Buscador -->
    <div class="row mb-3">
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('main.lista_pacientes') }}" class="d-flex">
                <input type="text" 
                       name="q" 
                       class="form-control me-2" 
                       placeholder="Buscar por nombre o identificación..." 
                       value="{{ query if query else '' }}">
                <button type="submit" class="btn btn-secondary">
                    <i class="fas fa-search"></i> Buscar
                </button>
                {% if query %}
                <a href="{{ url_for('main.lista_pacientes') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    {% if pacientes %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Identificación</th>
                    <th>Sexo</th>
                    <th>Fecha de Nacimiento</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for paciente in pacientes %}
                <tr>
                    <td>{{ paciente.id }}</td>
                    <td>{{ paciente.nombre }}</td>
                    <td>{{ paciente.identificacion }}</td>
                    <td>{{ paciente.sexo or 'N/A' }}</td>
                    <td>{{ paciente.fecha_nacimiento.strftime('%d/%m/%Y') if paciente.fecha_nacimiento else 'N/A' }}</td>
                    <td>{{ paciente.telefono or 'N/A' }}</td>
                    <td>{{ paciente.email or 'N/A' }}</td>
                    <td>
                        <a href="{{ url_for('main.historia_clinica', id=paciente.id) }}"
                           class="btn btn-sm btn-success me-1">
                            Historia
                        </a>
                        <a href="{{ url_for('main.editar_paciente', id=paciente.id) }}"
                           class="btn btn-sm btn-info me-1">
                            Editar
                        </a>
                        <button type="button"
                                class="btn btn-sm btn-danger"
                                onclick="eliminarPaciente({{ paciente.id }}, '{{ paciente.nombre }}')">
                            Eliminar
                        </button>
                        <form id="formEliminarPaciente{{ paciente.id }}"
                              action="{{ url_for('main.eliminar_paciente', id=paciente.id) }}"
                              method="POST"
                              style="display: none;">
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 
        {% if query %}
            No se encontraron pacientes con "{{ query }}"
        {% else %}
            No hay pacientes registrados.
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function eliminarPaciente(pacienteId, pacienteNombre) {
Swal.fire({
    title: '¿Eliminar paciente?',
    text: `¿Está seguro de eliminar al paciente ${pacienteNombre}? Esta acción no se puede deshacer.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
}).then((result) => {
    if (result.isConfirmed) {
        document.getElementById('formEliminarPaciente' + pacienteId).submit();
    }
});
}
</script>
{% endblock %}